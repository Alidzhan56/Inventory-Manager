{% extends "base.html" %}
{% block content %}
<style>
  #pwRules .rule-row i { width: 18px; }
</style>

<div class="container py-4" style="max-width: 520px;">
  <h3 class="mb-3">{{ _("Change Password") }}</h3>

  <form method="post" id="changePwForm">
    <div class="mb-3">
      <label class="form-label">{{ _("Current password") }}</label>
      <input type="password" name="current_password" class="form-control" required autocomplete="current-password">
    </div>

    <div class="mb-3">
      <label class="form-label">{{ _("New password") }}</label>

      <div class="input-group">
        <input
          type="password"
          name="new_password"
          id="newPassword"
          class="form-control"
          required
          autocomplete="new-password"
        >
        <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword" tabindex="-1"
                title="{{ _('Show/Hide') }}">
          <i class="bi bi-eye"></i>
        </button>
      </div>

      <div class="mt-2 small" id="pwRules">
        <div class="fw-semibold mb-1">{{ _("Password requirements:") }}</div>

        <div class="d-flex align-items-center gap-2 rule-row" data-rule="len">
          <i class="bi bi-x-circle text-danger"></i>
          <span>{{ _("At least 8 characters") }}</span>
        </div>
        <div class="d-flex align-items-center gap-2 rule-row" data-rule="upper">
          <i class="bi bi-x-circle text-danger"></i>
          <span>{{ _("At least 1 uppercase letter (A-Z)") }}</span>
        </div>
        <div class="d-flex align-items-center gap-2 rule-row" data-rule="lower">
          <i class="bi bi-x-circle text-danger"></i>
          <span>{{ _("At least 1 lowercase letter (a-z)") }}</span>
        </div>
        <div class="d-flex align-items-center gap-2 rule-row" data-rule="digit">
          <i class="bi bi-x-circle text-danger"></i>
          <span>{{ _("At least 1 number (0-9)") }}</span>
        </div>
        <div class="d-flex align-items-center gap-2 rule-row" data-rule="symbol">
          <i class="bi bi-x-circle text-danger"></i>
          <span>{{ _("At least 1 symbol (!@#...)") }}</span>
        </div>

        <div class="d-flex align-items-center gap-2 rule-row mt-2" data-rule="match">
          <i class="bi bi-x-circle text-danger"></i>
          <span>{{ _("Confirm password matches") }}</span>
        </div>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">{{ _("Confirm new password") }}</label>
      <input
        type="password"
        name="confirm_password"
        id="confirmPassword"
        class="form-control"
        required
        autocomplete="new-password"
      >
    </div>

    <button class="btn btn-primary w-100" type="submit" id="submitBtn" disabled>
      <i class="bi bi-shield-lock"></i> {{ _("Update Password") }}
    </button>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("changePwForm");
  const pw = document.getElementById("newPassword");
  const cpw = document.getElementById("confirmPassword");
  const rulesBox = document.getElementById("pwRules");
  const submitBtn = document.getElementById("submitBtn");
  const toggleBtn = document.getElementById("toggleNewPassword");

  if (!pw || !cpw || !rulesBox) return;

  const rows = {
    len: rulesBox.querySelector('[data-rule="len"]'),
    upper: rulesBox.querySelector('[data-rule="upper"]'),
    lower: rulesBox.querySelector('[data-rule="lower"]'),
    digit: rulesBox.querySelector('[data-rule="digit"]'),
    symbol: rulesBox.querySelector('[data-rule="symbol"]'),
    match: rulesBox.querySelector('[data-rule="match"]'),
  };

  function setRow(row, ok) {
    if (!row) return;
    const icon = row.querySelector("i");
    if (!icon) return;
    icon.className = ok ? "bi bi-check-circle text-success" : "bi bi-x-circle text-danger";
  }

  function validate(value) {
    return {
      len: value.length >= 8,
      upper: /[A-Z]/.test(value),
      lower: /[a-z]/.test(value),
      digit: /\d/.test(value),
      symbol: /[^a-zA-Z0-9]/.test(value),
    };
  }

  function updateUI() {
    const v = pw.value || "";
    const c = cpw.value || "";
    const r = validate(v);

    setRow(rows.len, r.len);
    setRow(rows.upper, r.upper);
    setRow(rows.lower, r.lower);
    setRow(rows.digit, r.digit);
    setRow(rows.symbol, r.symbol);

    const matchOk = v.length > 0 && v === c;
    setRow(rows.match, matchOk);

    const allOk = r.len && r.upper && r.lower && r.digit && r.symbol && matchOk;

    // input styling (optional)
    if (v.length === 0) {
      pw.classList.remove("is-valid", "is-invalid");
    } else {
      pw.classList.toggle("is-valid", r.len && r.upper && r.lower && r.digit && r.symbol);
      pw.classList.toggle("is-invalid", !(r.len && r.upper && r.lower && r.digit && r.symbol));
    }

    if (c.length === 0) {
      cpw.classList.remove("is-valid", "is-invalid");
    } else {
      cpw.classList.toggle("is-valid", matchOk);
      cpw.classList.toggle("is-invalid", !matchOk);
    }

    if (submitBtn) submitBtn.disabled = !allOk;
    return allOk;
  }

  pw.addEventListener("input", updateUI);
  cpw.addEventListener("input", updateUI);

  if (toggleBtn) {
    toggleBtn.addEventListener("click", function () {
      const isPw = pw.getAttribute("type") === "password";
      pw.setAttribute("type", isPw ? "text" : "password");
      const icon = toggleBtn.querySelector("i");
      if (icon) icon.className = isPw ? "bi bi-eye-slash" : "bi bi-eye";
    });
  }

  if (form) {
    form.addEventListener("submit", function (e) {
      if (!updateUI()) {
        e.preventDefault();
        pw.focus();
      }
    });
  }

  updateUI();
});
</script>
{% endblock %}

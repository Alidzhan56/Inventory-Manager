{% extends 'base.html' %}

{% block title %}{{ _('Home') }} · WarePulse{% endblock %}

{% block content %}
<style>
  /* Леко “появяване” на елементите */
  .fade-up {
    opacity: 0;
    transform: translateY(10px);
    animation: fadeUp .55s ease forwards;
  }
  .fade-up.d2 { animation-delay: .08s; }
  .fade-up.d3 { animation-delay: .16s; }
  .fade-up.d4 { animation-delay: .24s; }
  .fade-up.d5 { animation-delay: .32s; }

  @keyframes fadeUp {
    to { opacity: 1; transform: translateY(0); }
  }

  .kpi-icon {
    width: 44px;
    height: 44px;
    border-radius: 14px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: rgba(13,110,253,0.10);
  }

  .mini-kpi {
    border: 1px solid rgba(15,23,42,0.06);
    border-radius: 14px;
    padding: 14px;
    background: #fff;
    box-shadow: var(--shadow);
  }

  .table-tight td, .table-tight th {
    padding-top: .65rem;
    padding-bottom: .65rem;
  }

  .chip {
    display: inline-flex;
    gap: 8px;
    align-items: center;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid rgba(15,23,42,0.08);
    background: rgba(255,255,255,0.7);
    backdrop-filter: blur(6px);
    font-size: .85rem;
    color: #334155;
  }
  .chip i { opacity: .9; }

  .money {
    font-variant-numeric: tabular-nums;
    letter-spacing: -0.01em;
  }

  .net-positive { color: #198754; }
  .net-negative { color: #dc3545; }
</style>

<div class="container-fluid">

  <!-- Горен ред: поздрав + бързи бутони -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 mb-4 fade-up">
    <div>
      <h3 class="fw-bold mb-1">{{ _('Welcome') }}, {{ current_user.username }}!</h3>

      {% if g.app_config and g.app_config.company_name %}
        <div class="text-muted">{{ g.app_config.company_name }}</div>
      {% endif %}

      <div class="text-muted">{{ _('Here is your dashboard overview.') }}</div>

      <!-- Малки “етикети” за ориентация -->
      <div class="d-flex gap-2 flex-wrap mt-3">
        <span class="chip"><i class="bi bi-calendar3"></i>{{ _('This month') }}</span>
        <span class="chip"><i class="bi bi-graph-up-arrow"></i>{{ _('Last 12 months') }}</span>
        <span class="chip"><i class="bi bi-shield-check"></i>{{ _('Org scoped') }}</span>
      </div>
    </div>

    <div class="d-flex gap-2 flex-wrap">
      <a href="{{ url_for('transactions.transactions') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle me-1"></i>{{ _('Record Transaction') }}
      </a>
      <a href="{{ url_for('products.products') }}" class="btn btn-outline-secondary">
        <i class="bi bi-box-seam me-1"></i>{{ _('Products') }}
      </a>
      <a href="{{ url_for('partners.partners') }}" class="btn btn-outline-secondary">
        <i class="bi bi-people me-1"></i>{{ _('Partners') }}
      </a>
    </div>
  </div>

  <!-- 4 основни KPI карти -->
  <div class="row g-3 fade-up d2">
    <div class="col-md-3 col-sm-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="kpi-icon"><i class="bi bi-box-seam fs-4 text-primary"></i></div>
          <div>
            <div class="text-muted small">{{ _('Total Products') }}</div>
            <div class="fs-3 fw-bold">{{ total_products or 0 }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="kpi-icon" style="background: rgba(25,135,84,0.10);">
            <i class="bi bi-building fs-4 text-success"></i>
          </div>
          <div>
            <div class="text-muted small">{{ _('Total Warehouses') }}</div>
            <div class="fs-3 fw-bold">{{ total_warehouses or 0 }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="kpi-icon" style="background: rgba(255,193,7,0.14);">
            <i class="bi bi-arrow-left-right fs-4 text-warning"></i>
          </div>
          <div>
            <div class="text-muted small">{{ _('Transactions') }}</div>
            <div class="fs-3 fw-bold">{{ total_transactions or 0 }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="kpi-icon" style="background: rgba(220,53,69,0.10);">
            <i class="bi bi-people fs-4 text-danger"></i>
          </div>
          <div>
            <div class="text-muted small">{{ _('Partners') }}</div>
            <div class="fs-3 fw-bold">{{ total_partners or 0 }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- KPI за текущия месец -->
  <div class="row g-3 mt-1 fade-up d3">
    <div class="col-lg-3 col-md-6">
      <div class="mini-kpi">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="text-muted small">{{ _('Sales (this month)') }}</div>
            <div class="fs-4 fw-bold money">
              <span class="me-1">{{ g.app_config.currency if g.app_config and g.app_config.currency else '' }}</span>
              <span class="money" data-money="{{ month_sales_total or 0 }}">{{ '%.2f'|format(month_sales_total or 0) }}</span>
            </div>
            <div class="text-muted small mt-1">{{ month_sales_count or 0 }} {{ _('sales') }}</div>
          </div>
          <i class="bi bi-graph-up fs-4 text-success"></i>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6">
      <div class="mini-kpi">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="text-muted small">{{ _('Purchases (this month)') }}</div>
            <div class="fs-4 fw-bold money">
              <span class="me-1">{{ g.app_config.currency if g.app_config and g.app_config.currency else '' }}</span>
              <span class="money" data-money="{{ month_purchases_total or 0 }}">{{ '%.2f'|format(month_purchases_total or 0) }}</span>
            </div>
            <div class="text-muted small mt-1">{{ month_purchase_count or 0 }} {{ _('purchases') }}</div>
          </div>
          <i class="bi bi-bag-plus fs-4 text-primary"></i>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6">
      <div class="mini-kpi">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="text-muted small">{{ _('Profit (this month)') }}</div>
            <div class="fs-4 fw-bold money">
              <span class="me-1">{{ g.app_config.currency if g.app_config and g.app_config.currency else '' }}</span>
              <span class="money" data-money="{{ month_profit or 0 }}">{{ '%.2f'|format(month_profit or 0) }}</span>
            </div>
            <div class="text-muted small mt-1">{{ _('Sales profit sum') }}</div>
          </div>
          <i class="bi bi-piggy-bank fs-4 text-warning"></i>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6">
      <div class="mini-kpi">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="text-muted small">{{ _('Net Flow (this month)') }}</div>
            <div class="fs-4 fw-bold money {{ 'net-positive' if (month_net_flow or 0) >= 0 else 'net-negative' }}">
              <span class="me-1">{{ g.app_config.currency if g.app_config and g.app_config.currency else '' }}</span>
              <span class="money" data-money="{{ month_net_flow or 0 }}">{{ '%.2f'|format(month_net_flow or 0) }}</span>
            </div>
            <div class="text-muted small mt-1">{{ _('Sales - Purchases') }}</div>
          </div>
          <i class="bi bi-cash-coin fs-4 text-secondary"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Графики -->
  <div class="row g-3 mt-2 fade-up d4">
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <div class="fw-semibold">{{ _('Monthly Sales & Purchases') }}</div>
          <span class="text-muted small">{{ _('Last 12 months') }}</span>
        </div>
        <div class="card-body">
          <canvas id="moneyChart" height="120"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <div class="fw-semibold">{{ _('Monthly Transactions Count') }}</div>
          <span class="text-muted small">{{ _('Last 12 months') }}</span>
        </div>
        <div class="card-body">
          <canvas id="countChart" height="140"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-0 fade-up d5">
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <div class="fw-semibold">{{ _('Products by Category') }}</div>
          <span class="text-muted small">{{ _('Live') }}</span>
        </div>
        <div class="card-body">
          <canvas id="productsChart" height="170"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <div class="fw-semibold"><i class="bi bi-stars me-2 text-warning"></i>{{ _('Top Products (last 30 days)') }}</div>
          <span class="text-muted small">{{ _('By quantity sold') }}</span>
        </div>

        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 table-tight">
              <thead class="table-light">
                <tr>
                  <th>{{ _('Product') }}</th>
                  <th class="text-end">{{ _('Qty Sold') }}</th>
                  <th class="text-end">{{ _('Revenue') }}</th>
                  <th class="text-end">{{ _('Profit') }}</th>
                </tr>
              </thead>
              <tbody>
                {% for p in top_products %}
                  <tr>
                    <td class="fw-semibold">
                      {{ p.name }} <span class="text-muted small">({{ p.sku }})</span>
                    </td>
                    <td class="text-end fw-bold">{{ p.qty_sold or 0 }}</td>
                    <td class="text-end money">
                      <span class="me-1">{{ g.app_config.currency if g.app_config and g.app_config.currency else '' }}</span>
                      <span class="money" data-money="{{ p.revenue or 0 }}">{{ '%.2f'|format(p.revenue or 0) }}</span>
                    </td>
                    <td class="text-end money">
                      <span class="me-1">{{ g.app_config.currency if g.app_config and g.app_config.currency else '' }}</span>
                      <span class="money" data-money="{{ p.profit or 0 }}">{{ '%.2f'|format(p.profit or 0) }}</span>
                    </td>
                  </tr>
                {% else %}
                  <tr>
                    <td colspan="4" class="text-center text-muted py-4">{{ _('No sales in the last 30 days.') }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="row g-3 mt-3">
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white fw-semibold d-flex align-items-center">
          <i class="bi bi-exclamation-triangle me-2 text-warning"></i>{{ _('Low Stock') }}
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 table-tight">
              <thead class="table-light">
                <tr>
                  <th>{{ _('Product') }}</th>
                  <th>{{ _('Warehouse') }}</th>
                  <th class="text-end">{{ _('Qty') }}</th>
                </tr>
              </thead>
              <tbody>
                {% for s in low_stock %}
                  <tr>
                    <td class="fw-semibold">{{ s.product.name if s.product else '-' }}</td>
                    <td class="text-muted">{{ s.warehouse.name if s.warehouse else '-' }}</td>
                    <td class="text-end fw-bold">{{ s.quantity or 0 }}</td>
                  </tr>
                {% else %}
                  <tr>
                    <td colspan="3" class="text-center text-muted py-3">{{ _('No low stock items.') }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white fw-semibold d-flex align-items-center">
          <i class="bi bi-clock-history me-2 text-secondary"></i>{{ _('Latest Transactions') }}
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 table-tight">
              <thead class="table-light">
                <tr>
                  <th>{{ _('Date') }}</th>
                  <th>{{ _('Type') }}</th>
                  <th>{{ _('Partner') }}</th>
                  <th class="text-end">{{ _('Items') }}</th>
                </tr>
              </thead>
              <tbody>
                {% for t in recent_txns %}
                  <tr>
                    <td class="text-muted">{{ t.date.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                      {% if t.type == 'Purchase' %}
                        <span class="badge bg-success">{{ _('Purchase') }}</span>
                      {% else %}
                        <span class="badge bg-danger">{{ _('Sale') }}</span>
                      {% endif %}
                    </td>
                    <td>{{ t.partner.name if t.partner else '-' }}</td>
                    <td class="text-end">{{ t.items|length }}</td>
                  </tr>
                {% else %}
                  <tr>
                    <td colspan="4" class="text-center text-muted py-3">{{ _('No recent transactions.') }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // --------- Данни от backend (Jinja -> JS) ---------
  const currency = {{ (g.app_config.currency if g.app_config and g.app_config.currency else '')|tojson }};

  const months = {{ transaction_months|tojson }};
  const txnCounts = {{ transaction_counts|tojson }};
  const saleCounts = {{ sale_counts|tojson }};
  const purchaseCounts = {{ purchase_counts|tojson }};

  const saleAmounts = {{ sale_amounts|tojson }};
  const purchaseAmounts = {{ purchase_amounts|tojson }};
  const profitAmounts = {{ profit_amounts|tojson }};

  // --------- Малък helper за “къс” формат (K/M) ---------
  const fmtMoney = (n) => {
    const num = Number(n || 0);
    try {
      const abs = Math.abs(num);
      if (abs >= 1000000) return (num / 1000000).toFixed(2) + "M";
      if (abs >= 1000) return (num / 1000).toFixed(2) + "K";
      return num.toFixed(2);
    } catch (e) {
      return (num || 0).toFixed(2);
    }
  };

  // Превръщам всички елементи с data-money в по-компактен текст
  document.querySelectorAll('[data-money]').forEach(el => {
    const raw = el.getAttribute('data-money');
    el.textContent = fmtMoney(raw);
  });

  // Tooltip форматиране (пълна сума с валута)
  const tooltipMoney = (value) => `${currency ? currency + " " : ""}${Number(value || 0).toFixed(2)}`;

  // 1) Линия: Sales / Purchases / Profit
  const moneyCtx = document.getElementById('moneyChart').getContext('2d');
  new Chart(moneyCtx, {
    type: 'line',
    data: {
      labels: months,
      datasets: [
        { label: "{{ _('Sales') }}", data: saleAmounts, tension: 0.35, fill: true, pointRadius: 2 },
        { label: "{{ _('Purchases') }}", data: purchaseAmounts, tension: 0.35, fill: true, pointRadius: 2 },
        { label: "{{ _('Profit') }}", data: profitAmounts, tension: 0.35, fill: false, borderDash: [6, 5], pointRadius: 2 }
      ]
    },
    options: {
      responsive: true,
      animation: { duration: 700 },
      interaction: { intersect: false, mode: 'index' },
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.dataset.label}: ${tooltipMoney(ctx.parsed.y)}`
          }
        }
      },
      scales: {
        x: { grid: { display: false } },
        y: {
          beginAtZero: true,
          ticks: { callback: (v) => fmtMoney(v) }
        }
      }
    }
  });

  // 2) Bar: брой транзакции (stacked)
  const countCtx = document.getElementById('countChart').getContext('2d');
  new Chart(countCtx, {
    type: 'bar',
    data: {
      labels: months,
      datasets: [
        { label: "{{ _('Purchases') }}", data: purchaseCounts, borderRadius: 8, maxBarThickness: 22 },
        { label: "{{ _('Sales') }}", data: saleCounts, borderRadius: 8, maxBarThickness: 22 },
      ]
    },
    options: {
      responsive: true,
      animation: { duration: 700 },
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y}` }
        }
      },
      scales: {
        x: { stacked: true, grid: { display: false } },
        y: { stacked: true, beginAtZero: true, ticks: { precision: 0 } }
      }
    }
  });

  // 3) Doughnut: продукти по категории
  const categories = {{ product_categories|tojson }};
  const categoryCounts = {{ product_counts|tojson }};

  const prodCtx = document.getElementById('productsChart').getContext('2d');
  new Chart(prodCtx, {
    type: 'doughnut',
    data: {
      labels: categories,
      datasets: [{ data: categoryCounts, hoverOffset: 8 }]
    },
    options: {
      responsive: true,
      animation: { duration: 750 },
      cutout: '62%',
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          callbacks: { label: (ctx) => `${ctx.label}: ${ctx.parsed}` }
        }
      }
    }
  });
</script>
{% endblock %}

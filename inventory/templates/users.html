{% extends "base.html" %}
{% block title %}{{ _('Manage Users') }} · WarePulse{% endblock %}

{% block content %}

<style>
  /* Малко page-specific polish (анимация при зареждане) */
  .wp-fade-in {
    animation: wpFadeIn .45s ease both;
  }
  @keyframes wpFadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* Чип за "You" */
  .wp-chip {
    display: inline-flex;
    align-items: center;
    gap: .35rem;
    padding: .25rem .55rem;
    border-radius: 999px;
    font-weight: 600;
    font-size: .78rem;
    border: 1px solid rgba(15,23,42,.12);
    background: rgba(255,255,255,.75);
  }

  /* Поле за търсене с иконка */
  .wp-search { position: relative; }
  .wp-search i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    opacity: .65;
  }
  .wp-search input { padding-left: 38px; }

  /* Таблица */
  .wp-table td, .wp-table th { vertical-align: middle; }
  .wp-actions .btn { border-radius: 12px; }

  /* Бадж за роли */
  .role-badge {
    border-radius: 999px;
    font-weight: 700;
    letter-spacing: .01em;
    padding: .35rem .6rem;
  }

  /* Празно състояние */
  .empty-state {
    border: 1px dashed rgba(15,23,42,.18);
    border-radius: 16px;
    background: rgba(255,255,255,.6);
  }

  /* Модали */
  .modal .modal-content { border: 0; border-radius: 16px; }
  .modal .modal-header { border-bottom: 1px solid rgba(15,23,42,.08); }
  .modal .modal-footer { border-top: 1px solid rgba(15,23,42,.08); }

  /* Правила за парола */
  #pwRules .rule-row i { width: 18px; }
</style>

<div class="wp-fade-in">

  <!-- Заглавие -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 mb-4">
    <div>
      <h3 class="fw-bold mb-0">{{ _('Manage Users') }}</h3>
      <div class="text-muted mt-1">{{ _('Create users and control access by role.') }}</div>
    </div>

    {# Само Admin/Owner и Developer могат да добавят потребители #}
    {% if current_user.role in ['Admin / Owner', 'Developer'] %}
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
        <i class="bi bi-person-plus me-1"></i>{{ _('Add User') }}
      </button>
    {% endif %}
  </div>

  <!-- Търсене и филтър -->
  <div class="card mb-4">
    <div class="card-header bg-white fw-semibold d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center">
        <i class="bi bi-funnel me-2 text-secondary"></i>{{ _('Search & Filter') }}
      </div>
      <!-- Reset към чист URL -->
      <a class="btn btn-sm btn-outline-secondary"
         href="{{ url_for('users.users') }}">
        <i class="bi bi-arrow-counterclockwise me-1"></i>{{ _('Reset') }}
      </a>
    </div>

    <div class="card-body">
      <form method="GET" action="{{ url_for('users.users') }}" class="row g-3 align-items-end">
        <div class="col-md-7">
          <label class="form-label">{{ _('Search') }}</label>
          <div class="wp-search">
            <i class="bi bi-search"></i>
            <input
              class="form-control"
              name="q"
              value="{{ q or request.args.get('q','') }}"
              placeholder="{{ _('Search by username or email...') }}"
            >
          </div>
        </div>

        <div class="col-md-3">
          <label class="form-label">{{ _('Role') }}</label>
          {% set _f = (f_role or request.args.get('role','')) %}
          <select class="form-select" name="role">
            <option value="">{{ _('All') }}</option>
            <option value="Admin / Owner" {% if _f == 'Admin / Owner' %}selected{% endif %}>{{ _('Admin / Owner') }}</option>
            <option value="Warehouse Manager" {% if _f == 'Warehouse Manager' %}selected{% endif %}>{{ _('Warehouse Manager') }}</option>
            <option value="Sales Agent" {% if _f == 'Sales Agent' %}selected{% endif %}>{{ _('Sales Agent') }}</option>
            <option value="Developer" {% if _f == 'Developer' %}selected{% endif %}>{{ _('Developer') }}</option>
          </select>
        </div>

        <div class="col-md-2 d-grid">
          <button class="btn btn-outline-primary">
            <i class="bi bi-search me-1"></i>{{ _('Apply') }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Таблица с потребители -->
  <div class="card">
    <div class="card-header bg-white fw-semibold d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center">
        <i class="bi bi-people me-2 text-secondary"></i>{{ _('Existing Users') }}
      </div>
      <div class="text-muted small">{{ users|length }} {{ _('total') }}</div>
    </div>

    <div class="card-body table-responsive">
      {% if users and users|length > 0 %}
        <table class="table table-hover align-middle mb-0 wp-table">
          <thead class="table-light">
            <tr>
              <th style="width:70px">#</th>
              <th>{{ _('Username') }}</th>
              <th>{{ _('Email') }}</th>
              <th style="width:220px">{{ _('Role') }}</th>
              <th class="text-end" style="width:260px">{{ _('Actions') }}</th>
            </tr>
          </thead>

          <tbody>
            {% for u in users %}
            <tr>
              <td class="text-muted">{{ loop.index }}</td>

              <td class="fw-semibold">
                {# Маркирам текущия потребител #}
                {% if u.id == current_user.id %}
                  <span class="wp-chip me-2"><i class="bi bi-person-check"></i>{{ _('You') }}</span>
                {% endif %}
                {{ u.username }}
              </td>

              <td class="text-muted">{{ u.email }}</td>

              <td>
                {% if u.role == 'Admin / Owner' %}
                  <span class="badge bg-primary role-badge">{{ _('Admin / Owner') }}</span>
                {% elif u.role == 'Warehouse Manager' %}
                  <span class="badge bg-success role-badge">{{ _('Warehouse Manager') }}</span>
                {% elif u.role == 'Sales Agent' %}
                  <span class="badge bg-warning text-dark role-badge">{{ _('Sales Agent') }}</span>
                {% else %}
                  <span class="badge bg-secondary role-badge">{{ _(u.role) }}</span>
                {% endif %}
              </td>

              <td class="text-end wp-actions">
                {# Само Admin/Owner и Developer могат да управляват #}
                {% set can_manage = current_user.role in ['Admin / Owner', 'Developer'] %}
                {% set is_self = (u.id == current_user.id) %}

                <!-- Смяна на роля (disabled ако няма права или ако е себе си и не е Developer) -->
                <button
                  class="btn btn-sm btn-outline-warning me-1 edit-role-btn"
                  data-id="{{ u.id }}"
                  data-username="{{ u.username }}"
                  data-role="{{ u.role }}"
                  {% if not can_manage or (is_self and current_user.role != 'Developer') %}disabled{% endif %}
                  title="{{ _('Change role') }}"
                >
                  <i class="bi bi-shield-check"></i> {{ _('Role') }}
                </button>

                <!-- Изтриване (disabled ако няма права или ако е себе си) -->
                <form action="{{ url_for('users.delete_user', id=u.id) }}" method="POST" class="d-inline delete-form">
                  <button
                    type="submit"
                    class="btn btn-sm btn-outline-danger"
                    {% if not can_manage or is_self %}disabled{% endif %}
                    title="{{ _('Delete user') }}"
                  >
                    <i class="bi bi-trash"></i> {{ _('Delete') }}
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <!-- Празно състояние -->
        <div class="empty-state p-4 text-center">
          <div class="fs-5 fw-semibold mb-1">{{ _('No users found.') }}</div>
          <div class="text-muted">{{ _('Try changing your search filters, or add a new user.') }}</div>

          {% if current_user.role in ['Admin / Owner', 'Developer'] %}
            <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addUserModal">
              <i class="bi bi-person-plus me-1"></i>{{ _('Add User') }}
            </button>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>

</div>

<!-- Модал: Добавяне на потребител -->
{% if current_user.role in ['Admin / Owner', 'Developer'] %}
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <div class="modal-header bg-white">
        <h5 class="modal-title fw-semibold" id="addUserModalLabel">
          <i class="bi bi-person-plus me-2 text-primary"></i>{{ _('Add New User') }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>

      <form method="POST" action="{{ url_for('users.add_user') }}" id="addUserForm">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">{{ _('Email') }}</label>
              <input type="email" class="form-control" name="email" placeholder="{{ _('Email') }}" required>
            </div>

            <div class="col-md-4">
              <label class="form-label">{{ _('Username') }}</label>
              <input type="text" class="form-control" name="username" placeholder="{{ _('Username') }}" required minlength="3">
            </div>

            <!-- Парола + live checklist -->
            <div class="col-md-4">
              <label class="form-label">{{ _('Password') }}</label>

              <div class="input-group">
                <input
                  type="password"
                  class="form-control"
                  name="password"
                  id="newUserPassword"
                  placeholder="{{ _('Password') }}"
                  required
                  autocomplete="new-password"
                >
                <button class="btn btn-outline-secondary" type="button" id="toggleNewUserPassword" tabindex="-1"
                        title="{{ _('Show/Hide') }}">
                  <i class="bi bi-eye"></i>
                </button>
              </div>

              <div class="mt-2 small" id="pwRules">
                <div class="fw-semibold mb-1">{{ _('Password requirements:') }}</div>

                <div class="d-flex align-items-center gap-2 rule-row" data-rule="len">
                  <i class="bi bi-x-circle text-danger"></i>
                  <span>{{ _('At least 8 characters') }}</span>
                </div>

                <div class="d-flex align-items-center gap-2 rule-row" data-rule="upper">
                  <i class="bi bi-x-circle text-danger"></i>
                  <span>{{ _('At least 1 uppercase letter (A-Z)') }}</span>
                </div>

                <div class="d-flex align-items-center gap-2 rule-row" data-rule="lower">
                  <i class="bi bi-x-circle text-danger"></i>
                  <span>{{ _('At least 1 lowercase letter (a-z)') }}</span>
                </div>

                <div class="d-flex align-items-center gap-2 rule-row" data-rule="digit">
                  <i class="bi bi-x-circle text-danger"></i>
                  <span>{{ _('At least 1 number (0-9)') }}</span>
                </div>

                <div class="d-flex align-items-center gap-2 rule-row" data-rule="symbol">
                  <i class="bi bi-x-circle text-danger"></i>
                  <span>{{ _('At least 1 symbol (!@#...)') }}</span>
                </div>
              </div>

              <div class="form-text">{{ _('Tip: use a strong password. The checklist updates while typing.') }}</div>
            </div>

            <div class="col-md-4">
              <label class="form-label">{{ _('Role') }}</label>
              <select class="form-select" name="role" required>
                <option value="Warehouse Manager">{{ _('Warehouse Manager') }}</option>
                <option value="Sales Agent">{{ _('Sales Agent') }}</option>
                <option value="Admin / Owner">{{ _('Admin / Owner') }}</option>
              </select>
              <div class="form-text">
                {{ _('Admins can manage users and settings.') }}
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-primary" id="createUserSubmit">
            <i class="bi bi-check2-circle me-1"></i>{{ _('Create User') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<!-- Модал: Смяна на роля -->
<div class="modal fade" id="roleModal" tabindex="-1" aria-labelledby="roleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <div class="modal-header bg-white">
        <h5 class="modal-title fw-semibold" id="roleModalLabel">{{ _('Update Role') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>

      <form id="roleForm" method="POST">
        <div class="modal-body">
          <div class="text-muted small mb-2">{{ _('User') }}</div>
          <div class="fw-semibold mb-3" id="role-username">—</div>

          <label class="form-label">{{ _('Role') }}</label>
          <select class="form-select" name="role" id="role-select" required>
            <option value="Admin / Owner">{{ _('Admin / Owner') }}</option>
            <option value="Warehouse Manager">{{ _('Warehouse Manager') }}</option>
            <option value="Sales Agent">{{ _('Sales Agent') }}</option>
          </select>

          <div class="form-text mt-2">
            {{ _('Be careful with Admin access. It controls users and settings.') }}
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-primary">{{ _('Save') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // 1) Потвърждение при изтриване
  document.querySelectorAll('.delete-form').forEach(form => {
    form.addEventListener('submit', function (e) {
      const ok = confirm("{{ _('Are you sure you want to delete this user?') }}");
      if (!ok) e.preventDefault();
    });
  });

  // 2) Модал за смяна на роля (Role)
  const roleModalEl = document.getElementById('roleModal');
  const roleModal = roleModalEl ? new bootstrap.Modal(roleModalEl) : null;
  const roleForm = document.getElementById('roleForm');

  document.querySelectorAll('.edit-role-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      if (!roleModal) return;

      const id = this.dataset.id;
      const username = this.dataset.username;
      const role = this.dataset.role;

      document.getElementById('role-username').textContent = username;
      document.getElementById('role-select').value = role;

      // Изисква route: users.update_role(id)
      roleForm.action = "{{ url_for('users.update_role', id=0) }}".replace("/0", "/" + id);

      roleModal.show();
    });
  });

  // 3) Live валидация на парола в Add User модала
  const pw = document.getElementById("newUserPassword");
  const rulesBox = document.getElementById("pwRules");
  const submitBtn = document.getElementById("createUserSubmit");
  const toggleBtn = document.getElementById("toggleNewUserPassword");
  const addUserModalEl = document.getElementById("addUserModal");
  const addUserForm = document.getElementById("addUserForm");

  if (pw && rulesBox) {
    const rows = {
      len: rulesBox.querySelector('[data-rule="len"]'),
      upper: rulesBox.querySelector('[data-rule="upper"]'),
      lower: rulesBox.querySelector('[data-rule="lower"]'),
      digit: rulesBox.querySelector('[data-rule="digit"]'),
      symbol: rulesBox.querySelector('[data-rule="symbol"]'),
    };

    function setRow(row, ok) {
      if (!row) return;
      const icon = row.querySelector("i");
      if (!icon) return;
      icon.className = ok ? "bi bi-check-circle text-success" : "bi bi-x-circle text-danger";
    }

    function validate(value) {
      return {
        len: value.length >= 8,
        upper: /[A-Z]/.test(value),
        lower: /[a-z]/.test(value),
        digit: /\d/.test(value),
        symbol: /[^a-zA-Z0-9]/.test(value),
      };
    }

    function updatePasswordUI() {
      const value = pw.value || "";
      const r = validate(value);

      setRow(rows.len, r.len);
      setRow(rows.upper, r.upper);
      setRow(rows.lower, r.lower);
      setRow(rows.digit, r.digit);
      setRow(rows.symbol, r.symbol);

      const allOk = Object.values(r).every(Boolean);

      // Визуална индикация върху input-а
      if (value.length === 0) {
        pw.classList.remove("is-valid", "is-invalid");
      } else {
        pw.classList.toggle("is-valid", allOk);
        pw.classList.toggle("is-invalid", !allOk);
      }

      // Disable/Enable submit според валидността на паролата
      if (submitBtn) submitBtn.disabled = !allOk;
      return allOk;
    }

    pw.addEventListener("input", updatePasswordUI);

    // Show / Hide парола
    if (toggleBtn) {
      toggleBtn.addEventListener("click", function () {
        const isPw = pw.getAttribute("type") === "password";
        pw.setAttribute("type", isPw ? "text" : "password");
        const icon = toggleBtn.querySelector("i");
        if (icon) icon.className = isPw ? "bi bi-eye-slash" : "bi bi-eye";
      });
    }

    // Safety: не позволявай submit ако паролата не е валидна
    if (addUserForm) {
      addUserForm.addEventListener("submit", function (e) {
        const ok = updatePasswordUI();
        if (!ok) {
          e.preventDefault();
          pw.focus();
        }
      });
    }

    // Reset състояние при затваряне на модала
    if (addUserModalEl) {
      addUserModalEl.addEventListener("hidden.bs.modal", function () {
        if (addUserForm) addUserForm.reset();

        // връщам type=password и иконата
        pw.setAttribute("type", "password");
        if (toggleBtn) {
          const icon = toggleBtn.querySelector("i");
          if (icon) icon.className = "bi bi-eye";
        }

        // махам валид/инвалид класове
        pw.classList.remove("is-valid", "is-invalid");

        // връщам всички правила на "x"
        Object.values(rows).forEach(row => {
          if (!row) return;
          const icon = row.querySelector("i");
          if (icon) icon.className = "bi bi-x-circle text-danger";
        });

        if (submitBtn) submitBtn.disabled = true;
      });

      // При отваряне: бутон disabled докато не стане валидна паролата
      addUserModalEl.addEventListener("shown.bs.modal", function () {
        if (submitBtn) submitBtn.disabled = true;
        pw.focus();
      });
    }

    // initial
    if (submitBtn) submitBtn.disabled = true;
  }
});
</script>

{% endblock %}

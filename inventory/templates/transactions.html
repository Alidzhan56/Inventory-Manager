{# templates/transactions.html #}
{% extends 'base.html' %}
{% block title %}{{ _('Transactions') }} Â· WarePulse{% endblock %}

{% block content %}

<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 mb-4">
  <div>
    <h3 class="fw-bold mb-0">{{ _('Transactions') }}</h3>
    <div class="text-muted mt-1">{{ _('Record purchases and sales, track stock movements.') }}</div>
  </div>
</div>

<!-- RECORD TRANSACTION -->
<div class="card mb-4">
  <div class="card-header bg-white fw-semibold d-flex align-items-center">
    <i class="bi bi-plus-circle me-2 text-primary"></i>{{ _('Record Transaction') }}
  </div>

  <div class="card-body">
    <form method="POST" id="txnForm">

      <div class="row g-3 align-items-end mb-3">
        <div class="col-md-3">
          <label class="form-label">{{ _('Type') }}</label>

          <select id="txnType" name="type" class="form-select" required>
            <option value="">{{ _('Select type') }}</option>

            {# Sales Agent: Sale only (UI rule matches backend rule) #}
            {% if current_user.role == 'Sales Agent' %}
              <option value="Sale">{{ _('Sale') }}</option>
            {% else %}
              <option value="Purchase">{{ _('Purchase') }}</option>
              <option value="Sale">{{ _('Sale') }}</option>
            {% endif %}
          </select>

          {% if current_user.role == 'Sales Agent' %}
            <div class="form-text">
              {{ _('Sales Agents can record sales only.') }}
            </div>
          {% endif %}
        </div>

        <div class="col-md-4">
          <label class="form-label">{{ _('Partner') }}</label>
          <select name="partner_id" class="form-select" required>
            <option value="">{{ _('Select partner') }}</option>
            {% for partner in partners %}
              <option value="{{ partner.id }}">{{ partner.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-5">
          <label class="form-label">{{ _('Warehouse') }}</label>
          <select id="warehouseSelect" name="warehouse_id" class="form-select" required>
            <option value="">{{ _('Select warehouse') }}</option>
            {% for w in warehouses %}
              <option value="{{ w.id }}">{{ w.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- Lines -->
      <div class="border rounded-3 p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-semibold">
            <i class="bi bi-list-check me-2 text-secondary"></i>{{ _('Items') }}
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="addRowBtn">
            <i class="bi bi-plus-lg me-1"></i>{{ _('Add line') }}
          </button>
        </div>

        <div class="row g-2 text-muted small mb-2 d-none d-md-flex">
          <div class="col-md-5">{{ _('Product') }}</div>
          <div class="col-md-2">{{ _('Qty') }}</div>
          <div class="col-md-2">{{ _('Unit Price') }}</div>
          <div class="col-md-2">{{ _('Line Total') }}</div>
          <div class="col-md-1 text-end">{{ _('Remove') }}</div>
        </div>

        <div id="rowsContainer">
          <!-- one default row -->
          <div class="row g-2 align-items-end txn-row mb-2">
            <div class="col-md-5">
              <label class="form-label d-md-none">{{ _('Product') }}</label>
              <select name="product_id[]" class="form-select product-select" required>
                <option value="">{{ _('Select product') }}</option>
                {% for p in products %}
                  <option
                    value="{{ p.id }}"
                    data-buy="{{ p.default_purchase_price or 0 }}"
                    data-sell="{{ p.default_sell_price or 0 }}"
                    data-sku="{{ p.sku }}"
                  >
                    {{ p.name }} ({{ p.sku }})
                  </option>
                {% endfor %}
              </select>
              <div class="form-text d-none d-md-block">
                {{ _('Tip: unit price auto-fills based on type. You can still edit it.') }}
              </div>
            </div>

            <div class="col-md-2">
              <label class="form-label d-md-none">{{ _('Quantity') }}</label>
              <input type="number" name="qty[]" min="1" class="form-control qty-input" required>
              <div class="invalid-feedback">
                {{ _('Quantity is higher than available stock in this warehouse.') }}
              </div>
            </div>

            <div class="col-md-2">
              <label class="form-label d-md-none">{{ _('Unit Price') }}</label>
              <input type="number" name="unit_price[]" step="0.01" min="0" class="form-control price-input" required>
            </div>

            <div class="col-md-2">
              <label class="form-label d-md-none">{{ _('Line Total') }}</label>
              <input type="text" class="form-control line-total" value="0.00" readonly>
            </div>

            <div class="col-md-1 text-end">
              <button type="button" class="btn btn-outline-danger removeRowBtn">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>

            <div class="col-12">
              <div class="small text-muted stock-hint d-none">
                <i class="bi bi-info-circle me-1"></i>
                <span class="stock-text"></span>
              </div>
            </div>
          </div>
        </div>

        <hr class="my-3">

        <div class="d-flex justify-content-end">
          <div class="text-end">
            <div class="text-muted small">{{ _('Grand Total') }}</div>
            <div class="fs-4 fw-bold"><span id="grandTotal">0.00</span></div>
          </div>
        </div>
      </div>

      <div class="mt-3 d-flex gap-2">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-check2-circle me-1"></i>{{ _('Record Transaction') }}
        </button>
        <button type="reset" class="btn btn-outline-secondary" id="resetBtn">
          <i class="bi bi-arrow-counterclockwise me-1"></i>{{ _('Reset') }}
        </button>
      </div>

    </form>
  </div>
</div>

<!-- FILTERS -->
<div class="card mb-4">
  <div class="card-header bg-white fw-semibold d-flex align-items-center">
    <i class="bi bi-funnel me-2 text-secondary"></i>{{ _('Filter Transactions') }}
  </div>

  <div class="card-body">
    <form method="GET" class="row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label">{{ _('Type') }}</label>
        <select name="type" class="form-select">
          <option value="">{{ _('All') }}</option>
          <option value="Purchase" {% if request.args.get('type')=='Purchase' %}selected{% endif %}>{{ _('Purchase') }}</option>
          <option value="Sale" {% if request.args.get('type')=='Sale' %}selected{% endif %}>{{ _('Sale') }}</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">{{ _('Product') }}</label>
        <select name="product_id" class="form-select">
          <option value="">{{ _('All Products') }}</option>
          {% for p in products %}
            <option value="{{ p.id }}" {% if request.args.get('product_id')==p.id|string %}selected{% endif %}>
              {{ p.name }} ({{ p.sku }})
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">{{ _('Partner') }}</label>
        <select name="partner_id" class="form-select">
          <option value="">{{ _('All Partners') }}</option>
          {% for partner in partners %}
            <option value="{{ partner.id }}" {% if request.args.get('partner_id')==partner.id|string %}selected{% endif %}>
              {{ partner.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2 d-grid">
        <button class="btn btn-outline-primary">
          <i class="bi bi-search me-1"></i>{{ _('Apply') }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- HISTORY -->
<div class="card">
  <div class="card-header bg-white fw-semibold d-flex align-items-center justify-content-between">
    <div><i class="bi bi-clock-history me-2 text-secondary"></i>{{ _('Transaction History') }}</div>
    <div class="text-muted small">{{ txns|length }} {{ _('total') }}</div>
  </div>

  <div class="card-body table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>{{ _('Date') }}</th>
          <th>{{ _('Type') }}</th>
          <th>{{ _('Partner') }}</th>
          <th>{{ _('Warehouse') }}</th>
          <th class="text-end">{{ _('Items') }}</th>
          <th class="text-end">{{ _('Total') }}</th>
          <th>{{ _('User') }}</th>
        </tr>
      </thead>

      <tbody>
        {% for t in txns %}
          {% set txn_total = (t.items | sum(attribute='total_price')) %}
          <tr>
            <td class="text-muted">{{ t.date.strftime('%Y-%m-%d %H:%M') }}</td>

            <td>
              {% if t.type == 'Purchase' %}
                <span class="badge bg-success">{{ _('Purchase') }}</span>
              {% else %}
                <span class="badge bg-danger">{{ _('Sale') }}</span>
              {% endif %}
            </td>

            <td>{{ t.partner.name if t.partner else '-' }}</td>
            <td>{{ t.warehouse.name if t.warehouse else '-' }}</td>

            <td class="text-end">{{ t.items|length }}</td>
            <td class="text-end fw-semibold">{{ '%.2f'|format(txn_total or 0) }}</td>

            <td class="text-muted">
              <i class="bi bi-person me-1"></i>{{ t.user.username if t.user else '-' }}
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="7" class="text-center text-muted py-4">{{ _('No transactions found.') }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  // --- helpers ---
  const money = (n) => (isNaN(n) ? 0 : n).toFixed(2);

  // role guard (UI side). Backend already blocks, this is just nicer UX.
  const isSalesAgent = {{ 'true' if current_user.role == 'Sales Agent' else 'false' }};

  async function fetchStock(warehouseId, productId) {
    if (!warehouseId || !productId) return null;

    const url = "{{ url_for('transactions.api_stock') }}" + `?warehouse_id=${warehouseId}&product_id=${productId}`;
    const res = await fetch(url);
    const data = await res.json();
    if (!data.ok) return null;
    return data.quantity;
  }

  function setRowStockHint(row, qty) {
    const hint = row.querySelector('.stock-hint');
    const text = row.querySelector('.stock-text');
    if (!hint || !text) return;

    hint.classList.remove('d-none');
    text.textContent = `{{ _('Available') }}: ${qty}`;
    row.dataset.available = qty;
  }

  function clearRowStockHint(row) {
    const hint = row.querySelector('.stock-hint');
    if (hint) hint.classList.add('d-none');
    row.dataset.available = '';
  }

  function updateLineTotal(row) {
    const qty = parseFloat(row.querySelector('.qty-input')?.value || 0);
    const price = parseFloat(row.querySelector('.price-input')?.value || 0);
    row.querySelector('.line-total').value = money(qty * price);
  }

  function updateGrandTotal() {
    let sum = 0;
    document.querySelectorAll('.txn-row').forEach(row => {
      const v = parseFloat(row.querySelector('.line-total')?.value || 0);
      sum += (isNaN(v) ? 0 : v);
    });
    document.getElementById('grandTotal').textContent = money(sum);
  }

  function autofillUnitPrice(row) {
    const type = document.getElementById('txnType').value;
    const sel = row.querySelector('.product-select');
    if (!sel) return;

    const opt = sel.options[sel.selectedIndex];
    if (!opt) return;

    const buy = parseFloat(opt.dataset.buy || 0);
    const sell = parseFloat(opt.dataset.sell || 0);

    const priceInput = row.querySelector('.price-input');
    if (!priceInput) return;

    const current = parseFloat(priceInput.value || 0);
    if (current > 0) return;

    if (type === 'Purchase') priceInput.value = money(buy);
    if (type === 'Sale') priceInput.value = money(sell);
  }

  function validateSaleQty(row) {
    const type = document.getElementById('txnType').value;
    const qty = parseInt(row.querySelector('.qty-input')?.value || 0, 10);
    const available = parseInt(row.dataset.available || "NaN", 10);

    const qtyInput = row.querySelector('.qty-input');
    if (!qtyInput) return true;

    // validate only for Sale
    if (type !== 'Sale') {
      qtyInput.classList.remove('is-invalid');
      return true;
    }

    // if we don't know stock yet, don't block
    if (isNaN(available)) return true;

    if (qty > available) {
      qtyInput.classList.add('is-invalid');
      return false;
    } else {
      qtyInput.classList.remove('is-invalid');
      return true;
    }
  }

  function updateSubmitState() {
    const type = document.getElementById('txnType').value;
    const btn = document.querySelector('#txnForm button[type="submit"]');
    if (!btn) return;

    if (type !== 'Sale') {
      btn.disabled = false;
      return;
    }

    let ok = true;
    document.querySelectorAll('.txn-row').forEach(row => {
      if (!validateSaleQty(row)) ok = false;
    });

    btn.disabled = !ok;
  }

  async function refreshRowStock(row) {
    const type = document.getElementById('txnType').value;
    const warehouseId = document.getElementById('warehouseSelect')?.value;
    const productId = row.querySelector('.product-select')?.value;

    if (!warehouseId || !productId) {
      clearRowStockHint(row);
      return;
    }

    if (type !== 'Sale') {
      clearRowStockHint(row);
      return;
    }

    const qty = await fetchStock(warehouseId, productId);
    if (qty !== null) setRowStockHint(row, qty);
  }

  function bindRow(row) {
    row.querySelector('.removeRowBtn')?.addEventListener('click', () => {
      const allRows = document.querySelectorAll('.txn-row');
      if (allRows.length <= 1) {
        row.querySelectorAll('input, select').forEach(el => el.value = '');
        row.querySelector('.line-total').value = '0.00';
        clearRowStockHint(row);
        updateGrandTotal();
        updateSubmitState();
        return;
      }
      row.remove();
      updateGrandTotal();
      updateSubmitState();
    });

    row.querySelector('.qty-input')?.addEventListener('input', () => {
      updateLineTotal(row);
      updateGrandTotal();
      validateSaleQty(row);
      updateSubmitState();
    });

    row.querySelector('.price-input')?.addEventListener('input', () => {
      updateLineTotal(row);
      updateGrandTotal();
      updateSubmitState();
    });

    row.querySelector('.product-select')?.addEventListener('change', async () => {
      autofillUnitPrice(row);
      await refreshRowStock(row);
      updateLineTotal(row);
      updateGrandTotal();
      validateSaleQty(row);
      updateSubmitState();
    });
  }

  // --- add row ---
  document.getElementById('addRowBtn').addEventListener('click', async () => {
    const container = document.getElementById('rowsContainer');
    const first = container.querySelector('.txn-row');
    const clone = first.cloneNode(true);

    clone.querySelectorAll('input, select').forEach(el => {
      if (el.classList.contains('line-total')) return;
      el.value = '';
      el.classList.remove('is-invalid');
    });
    clone.querySelector('.line-total').value = '0.00';
    clearRowStockHint(clone);

    container.appendChild(clone);
    bindRow(clone);

    updateGrandTotal();
    updateSubmitState();
  });

  // warehouse change refreshes stock for all rows
  document.getElementById('warehouseSelect')?.addEventListener('change', async () => {
    for (const row of document.querySelectorAll('.txn-row')) {
      await refreshRowStock(row);
      validateSaleQty(row);
    }
    updateSubmitState();
  });

  // type change should allow refilling price if empty + refresh stock hints
  document.getElementById('txnType').addEventListener('change', async () => {
    if (isSalesAgent) {
      document.getElementById('txnType').value = 'Sale';
    }

    for (const row of document.querySelectorAll('.txn-row')) {
      autofillUnitPrice(row);
      await refreshRowStock(row);
      updateLineTotal(row);
      validateSaleQty(row);
    }

    updateGrandTotal();
    updateSubmitState();
  });

  // initial guard: sales agent default type + bind initial row
  window.addEventListener('DOMContentLoaded', async () => {
    if (isSalesAgent) {
      document.getElementById('txnType').value = 'Sale';
    }

    document.querySelectorAll('.txn-row').forEach(bindRow);

    // if warehouse + product already selected, refresh stock
    for (const row of document.querySelectorAll('.txn-row')) {
      await refreshRowStock(row);
      validateSaleQty(row);
    }

    updateSubmitState();
  });

  // reset button: totals + hints
  document.getElementById('resetBtn').addEventListener('click', () => {
    setTimeout(() => {
      if (isSalesAgent) {
        document.getElementById('txnType').value = 'Sale';
      }
      document.querySelectorAll('.txn-row').forEach(row => {
        row.querySelector('.line-total').value = '0.00';
        row.querySelector('.qty-input')?.classList.remove('is-invalid');
        clearRowStockHint(row);
      });
      document.getElementById('grandTotal').textContent = '0.00';
      updateSubmitState();
    }, 0);
  });
</script>

{% endblock %}

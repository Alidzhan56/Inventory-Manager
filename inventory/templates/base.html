<!DOCTYPE html>
<html lang="{{ g.lang or 'en' }}">
<head>
  <meta charset="UTF-8" />
  <title>{% block title %}{{ _('WarePulse') }}{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    :root {
      --sidebar-width: 255px;

      --bg: #f4f6f9;
      --surface: #ffffff;

      --topbar: #171725;
      --sidebar: #171725;
      --sidebar-border: rgba(255,255,255,0.08);

      --text: #0f172a;
      --muted: #64748b;

      --link: #cbd5e1;
      --link-hover: #ffffff;
      --link-active-bg: rgba(13, 110, 253, 0.18);
      --primary: #0d6efd;

      --shadow: 0 0.35rem 1.2rem rgba(15, 23, 42, 0.08);
      --radius: 14px;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      margin: 0;
    }

    /* Topbar */
    .topbar {
      background: var(--topbar);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      height: 60px;
    }

    .brand {
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 220px;
    }
    .brand img {
      height: 38px;
      width: 38px;
      border-radius: 10px;
      object-fit: cover;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .brand .name {
      color: #fff;
      font-weight: 750;
      letter-spacing: 0.2px;
      line-height: 1.05;
    }
    .brand .company {
      color: rgba(255,255,255,0.7);
      font-size: 0.82rem;
      line-height: 1.05;
    }

    .top-actions .btn,
    .top-actions .dropdown-toggle {
      border-radius: 12px;
    }

    /* Смяна на език (BG/EN) */
    .lang-pill a {
      color: rgba(255,255,255,0.75);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.85rem;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      margin-left: 6px;
    }
    .lang-pill a.active,
    .lang-pill a:hover {
      color: #fff;
      border-color: rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.06);
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 60px;
      left: 0;
      width: var(--sidebar-width);
      height: calc(100% - 60px);
      background: var(--sidebar);
      border-right: 1px solid var(--sidebar-border);
      padding: 14px 10px;
      overflow-y: auto;
      z-index: 2000;
      transform: translateX(0);
      transition: transform .25s ease;
    }

    .nav-group-label {
      color: rgba(255,255,255,0.45);
      font-size: 0.75rem;
      letter-spacing: .08em;
      text-transform: uppercase;
      padding: 12px 14px 6px;
    }

    .side-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 11px 14px;
      margin: 5px 8px;
      border-radius: 12px;
      text-decoration: none;
      color: var(--link);
      transition: background .15s ease, color .15s ease, transform .05s ease;
    }

    .side-link i {
      font-size: 1.1rem;
      width: 20px;
      text-align: center;
      opacity: 0.95;
    }

    .side-link:hover {
      color: var(--link-hover);
      background: rgba(255,255,255,0.06);
    }

    .side-link:active {
      transform: scale(0.99);
    }

    /* Активен линк в менюто */
    .side-link.active {
      background: var(--link-active-bg);
      color: #fff;
      border: 1px solid rgba(13,110,253,0.35);
    }

    /* Мобилно меню + overlay */
    .sidebar-overlay {
      position: fixed;
      inset: 60px 0 0 0;
      background: rgba(0,0,0,0.35);
      z-index: 1500;
      display: none;
    }

    @media (max-width: 991px) {
      .sidebar { transform: translateX(-105%); }
      .sidebar.open { transform: translateX(0); }
      .sidebar-overlay.open { display: block; }
    }

    /* Отместване на съдържанието (за да не влиза под менюто) */
    .content-wrap {
      margin-top: 60px;
      min-height: calc(100vh - 60px);
      display: flex;
      flex-direction: column;
    }

    .main-content {
      flex: 1;
      padding: 22px;
      transition: margin-left .25s ease;
    }

    @media (min-width: 992px) {
      .main-content {
        margin-left: var(--sidebar-width);
        padding: 26px 28px;
      }
    }

    /* Общи стилове за карти/таблици */
    .card {
      border: 0;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .card-header {
      border-bottom: 1px solid rgba(15,23,42,0.06);
      border-top-left-radius: var(--radius) !important;
      border-top-right-radius: var(--radius) !important;
    }
    .table thead th { font-weight: 700; color: #334155; }
    .alert { border-radius: 14px; box-shadow: var(--shadow); border: 0; }

    /* Footer */
    .footer { color: var(--muted); font-size: 0.85rem; padding: 16px 0 24px; }
    h1, h2, h3 { letter-spacing: -0.02em; }
  </style>
</head>

<body>

<!-- Topbar -->
<nav class="navbar navbar-dark topbar fixed-top">
  <div class="container-fluid">

    {% if current_user.is_authenticated and current_user.role != 'Developer' %}
      <!-- Бутон за отваряне на sidebar на телефон -->
      <button id="sidebarToggle" class="btn btn-sm btn-outline-light d-lg-none me-2" type="button">
        <i class="bi bi-list"></i>
      </button>
    {% endif %}

    <!-- Линкът на логото води към различна страница според ролята -->
    <a class="navbar-brand brand"
       href="{% if current_user.is_authenticated %}
                {% if current_user.role == 'Developer' %}
                  {{ url_for('users.developer_dashboard') }}
                {% else %}
                  {{ url_for('main.index') }}
                {% endif %}
              {% else %}
                {{ url_for('main.landing') }}
              {% endif %}">
      <img src="{{ url_for('static', filename='warepulse-logo.png') }}" alt="WarePulse Logo" />
      <div class="d-flex flex-column">
        <span class="name">WarePulse</span>
        <span class="company">{{ g.app_config.company_name if g.app_config else '' }}</span>
      </div>
    </a>

    <div class="ms-auto d-flex align-items-center gap-2 top-actions">
      <!-- Език -->
      <div class="lang-pill d-none d-sm-flex align-items-center">
        <a href="?lang=bg" class="{% if g.lang=='bg' %}active{% endif %}">BG</a>
        <a href="?lang=en" class="{% if g.lang=='en' %}active{% endif %}">EN</a>
      </div>

      {% if current_user.is_authenticated %}
        <!-- Профил меню -->
        <div class="dropdown">
          <a class="btn btn-outline-light btn-sm dropdown-toggle d-flex align-items-center gap-2"
             href="#" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-person-circle"></i>
            <span class="d-none d-sm-inline">{{ current_user.username }}</span>
          </a>

          <ul class="dropdown-menu dropdown-menu-end">
            <li><span class="dropdown-item-text text-muted small">{{ current_user.role }}</span></li>
            <li><hr class="dropdown-divider"></li>

            {% if current_user.role == 'Admin / Owner' %}
              <li>
                <a class="dropdown-item" href="{{ url_for('settings.settings') }}">
                  <i class="bi bi-gear me-2"></i>{{ _('Settings') }}
                </a>
              </li>
            {% endif %}

              <a class="dropdown-item d-flex align-items-center gap-2"
                 href="{{ url_for('settings.change_password') }}">
                 <i class="bi bi-shield-lock"></i>
                {{ _('Change Password') }}
             </a>

            <li>
              <a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}">
                <i class="bi bi-box-arrow-right me-2"></i>{{ _('Logout') }}
              </a>
            </li>
          </ul>
        </div>
      {% else %}
        <!-- Бутоните за вход/регистрация -->
        <a class="btn btn-outline-light btn-sm" href="{{ url_for('auth.login') }}">{{ _('Login') }}</a>
        <a class="btn btn-primary btn-sm" href="{{ url_for('auth.register_admin') }}">{{ _('Register') }}</a>
      {% endif %}
    </div>
  </div>
</nav>

{% if current_user.is_authenticated and current_user.role != 'Developer' %}
  <!-- Overlay за мобилен sidebar -->
  <div id="sidebarOverlay" class="sidebar-overlay"></div>

  <!-- Sidebar меню -->
  <aside id="sidebar" class="sidebar">
    <div class="nav-group-label">{{ _('Menu') }}</div>

    <a href="{{ url_for('main.index') }}"
       class="side-link {% if request.endpoint == 'main.index' %}active{% endif %}">
      <i class="bi bi-house-door"></i> {{ _('Home') }}
    </a>

    <a href="{{ url_for('products.products') }}"
       class="side-link {% if request.endpoint and request.endpoint.startswith('products.') %}active{% endif %}">
      <i class="bi bi-box-seam"></i> {{ _('Products') }}
    </a>

    <a href="{{ url_for('warehouses.warehouses') }}"
       class="side-link {% if request.endpoint and request.endpoint.startswith('warehouses.') %}active{% endif %}">
      <i class="bi bi-building"></i> {{ _('Warehouses') }}
    </a>

    <a href="{{ url_for('transactions.transactions') }}"
       class="side-link {% if request.endpoint and request.endpoint.startswith('transactions.') %}active{% endif %}">
      <i class="bi bi-arrow-left-right"></i> {{ _('Transactions') }}
    </a>

    <a href="{{ url_for('partners.partners') }}"
       class="side-link {% if request.endpoint and request.endpoint.startswith('partners.') %}active{% endif %}">
      <i class="bi bi-people"></i> {{ _('Partners') }}
    </a>

    {% if current_user.role == 'Admin / Owner' %}
      <div class="nav-group-label">{{ _('Admin') }}</div>

      <a href="{{ url_for('users.users') }}"
         class="side-link {% if request.endpoint and request.endpoint.startswith('users.') %}active{% endif %}">
        <i class="bi bi-person-gear"></i> {{ _('Users') }}
      </a>

      <a href="{{ url_for('reports.reports_home') }}"
         class="side-link {% if request.endpoint and request.endpoint.startswith('reports.') %}active{% endif %}">
        <i class="bi bi-file-earmark-bar-graph"></i> {{ _('Reports') }}
      </a>

      <a href="{{ url_for('settings.settings') }}"
         class="side-link {% if request.endpoint and request.endpoint.startswith('settings.') %}active{% endif %}">
        <i class="bi bi-gear"></i> {{ _('Settings') }}
      </a>
    {% endif %}
  </aside>
{% endif %}

<!-- Content -->
<div class="content-wrap">
  <main class="main-content">

    <!-- Flash съобщения -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  <footer class="footer text-center">
    <div class="container">
      {% set company = g.app_config.company_name if g.app_config else '' %}
      © {{ company }} · Powered by WarePulse
    </div>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

{% if current_user.is_authenticated and current_user.role != 'Developer' %}
<script>
  const sidebar = document.getElementById("sidebar");
  const overlay = document.getElementById("sidebarOverlay");
  const toggle = document.getElementById("sidebarToggle");

  // Отваряне/затваряне на sidebar (за мобилни устройства)
  function openSidebar() {
    if (!sidebar) return;
    sidebar.classList.add("open");
    if (overlay) overlay.classList.add("open");
  }

  function closeSidebar() {
    if (!sidebar) return;
    sidebar.classList.remove("open");
    if (overlay) overlay.classList.remove("open");
  }

  if (toggle) toggle.addEventListener("click", () => {
    if (!sidebar) return;
    const isOpen = sidebar.classList.contains("open");
    isOpen ? closeSidebar() : openSidebar();
  });

  if (overlay) overlay.addEventListener("click", closeSidebar);

  // Като натисна меню линк на телефон - затварям sidebar-а
  document.querySelectorAll(".side-link").forEach(link => {
    link.addEventListener("click", () => {
      if (window.innerWidth < 992) closeSidebar();
    });
  });

  // Ако се върна на desktop размер - махам overlay-а и sidebar state-а
  window.addEventListener("resize", () => {
    if (window.innerWidth >= 992) {
      if (overlay) overlay.classList.remove("open");
      if (sidebar) sidebar.classList.remove("open");
    }
  });
</script>
{% endif %}

</body>
</html>
